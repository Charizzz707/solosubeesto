<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Información del Dispositivo de la Imagen</title>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: white;
            margin: 0;
            padding: 0;
        }

        .banner-solido {
            position: relative;
            width: 100%;
            height: 100px;
            background-color: #e3f2fd;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .banner-solido h1 {
            color: #1976d2;
            font-size: 2.5em;
            margin: 0;
            font-weight: 600;
            white-space: nowrap;
        }

        .caja-aclaraciones {
            background-color: #e3f2fd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px auto;
            max-width: 800px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .caja-aclaraciones h2 {
            color: #1976d2;
            font-size: 1.5em;
            margin-top: 0;
        }

        .caja-aclaraciones ul {
            padding-left: 20px;
        }

        .caja-aclaraciones li {
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
        }

        .contenedor-botones {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            position: relative;
            z-index: 1001;
            flex-wrap: wrap;
        }

        .boton-archivos,
        .boton-carpeta,
        .boton-tabla {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            color: white;
            background-color: #4CAF50;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .boton-archivos:hover,
        .boton-carpeta:hover,
        .boton-tabla:hover {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .boton-archivos:active,
        .boton-carpeta:active,
        .boton-tabla:active {
            transform: translateY(0);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .boton-archivos {
            background-color: #2196F3;
        }

        .boton-archivos:hover {
            background-color: #1e88e5;
        }

        .boton-carpeta {
            background-color: #FF9800;
        }

        .boton-carpeta:hover {
            background-color: #fb8c00;
        }

        .boton-tabla {
            background-color: #9C27B0;
        }

        .boton-tabla:hover {
            background-color: #8E24AA;
        }

        .boton-tabla:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .lista-imagenes {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            position: relative;
            z-index: 1001;
        }

        .item-imagen {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            width: 250px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .item-imagen:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .item-imagen img {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .nombre-archivo {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 10px;
            text-align: center;
            background-color: #f0f0f0;
            padding: 8px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .info-imagen {
            margin-top: 15px;
            font-size: 14px;
            color: #333;
            text-align: left;
        }

        .info-imagen p {
            margin: 8px 0;
            line-height: 1.4;
        }

        .info-imagen strong {
            color: #4CAF50;
            font-weight: 500;
        }

        .destacado {
            font-weight: 600;
            color: #2196F3;
        }

        .contacto {
            margin-top: 20px;
            font-size: 14px;
            color: #333;
            text-align: left;
        }

        .contacto a {
            color: #2196F3;
            font-weight: 600;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .contacto a:hover {
            color: #1976d2;
        }

        #gifContainer {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            z-index: 1000;
            pointer-events: none;
            padding: 0 20px;
        }

        .inactivity-gif {
            width: 100px;
            height: auto;
            display: none;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

    <div class="banner-solido">
        <h1>Carpeta de fotos</h1>
    </div>

    <div class="caja-aclaraciones">
        <h2>¡Atención!</h2>
        <ul>
            <li><strong>Datos EXIF</strong>: Solo aparecen si las imágenes tienen la información incrustada. Si no, verás "Desconocido" en algunos campos.</li>
        </ul>
        <h2>Consejos</h2>
        <ul>
            <li>Usa imágenes directas de tu cámara para ver toda la información técnica.</li>
            <li>Si no ves los datos EXIF, revisa que las imágenes no hayan sido editadas o comprimidas.</li>
        </ul>

        <div class="contacto">
            <p>Dudas, quejas o sugerencias: <a href="mailto:unmazapan14@gmail.com">unmazapan14@gmail.com</a></p>
        </div>
    </div>

    <div class="contenedor-botones">
        <label for="entradaArchivos" class="boton-archivos">Seleccionar archivos</label>
        <input type="file" id="entradaArchivos" multiple accept="image/*" style="display: none;">

        <label for="entradaCarpeta" class="boton-carpeta">Seleccionar carpeta</label>
        <input type="file" id="entradaCarpeta" webkitdirectory directory accept="image/*" style="display: none;">

        <button id="botonTabla" class="boton-tabla" disabled>Crear tabla</button>
    </div>

    <div class="lista-imagenes" id="listaImagenes"></div>

    <div id="gifContainer"></div>

    <script>
        let imagenesData = [];
        let archivosOrdenados = [];

        function formatShutterSpeed(shutterSpeed) {
            if (!shutterSpeed) return 'N/A';
            if (shutterSpeed < 1) {
                const fraction = 1 / shutterSpeed;
                return `1/${Math.round(fraction)}s`;
            } else {
                return `${shutterSpeed}s`;
            }
        }

        // Función mejorada para ordenar archivos por nombre
        function ordenarArchivos(archivos) {
            return Array.from(archivos).sort((a, b) => {
                const nombreA = a.name.toLowerCase();
                const nombreB = b.name.toLowerCase();

                // Usar comparación natural que entiende números y letras
                return nombreA.localeCompare(nombreB, undefined, {
                    numeric: true,
                    sensitivity: 'base'
                });
            });
        }

        function procesarArchivos(archivos) {
            const listaImagenes = document.getElementById('listaImagenes');
            listaImagenes.innerHTML = '';
            imagenesData = [];

            // Ordenar archivos antes de procesarlos
            archivosOrdenados = ordenarArchivos(archivos);

            // Procesar cada archivo en orden
            procesarArchivoPorIndice(0);
        }

        function procesarArchivoPorIndice(index) {
            if (index >= archivosOrdenados.length) {
                // Todos los archivos procesados, habilitar botón de tabla
                if (imagenesData.length > 0) {
                    document.getElementById('botonTabla').disabled = false;
                }
                return;
            }

            const archivo = archivosOrdenados[index];

            if (archivo.type.startsWith("image/")) {
                const lector = new FileReader();

                lector.onload = (e) => {
                    const imagen = new Image();
                    imagen.src = e.target.result;
                    imagen.onload = () => {
                        const item = document.createElement('div');
                        item.classList.add('item-imagen');

                        const nombreArchivo = document.createElement('div');
                        nombreArchivo.classList.add('nombre-archivo');
                        nombreArchivo.textContent = archivo.name;

                        const divInfo = document.createElement('div');
                        divInfo.classList.add('info-imagen');

                        item.appendChild(nombreArchivo);
                        item.appendChild(imagen);

                        // Añadir al DOM inmediatamente para mantener orden
                        document.getElementById('listaImagenes').appendChild(item);

                        const { width, height } = imagen;
                        const tamanio = (archivo.size / 1024).toFixed(2);
                        const tamanioTexto = tamanio > 1024 ? (tamanio / 1024).toFixed(2) + ' MB' : tamanio + ' KB';

                        EXIF.getData(imagen, () => {
                            const exif = EXIF.getAllTags(imagen);
                            const iso = exif.ISOSpeedRatings || "Desconocido";
                            const numeroApertura = exif.FNumber ? exif.FNumber.toFixed(1) : "Desconocido";
                            const velocidadObturacion = exif.ExposureTime || "Desconocido";
                            const longitudFocal = exif.FocalLength ? exif.FocalLength + " mm" : "Desconocido";
                            const marca = exif.Make || "Desconocido";
                            const modelo = exif.Model || "Desconocido";
                            const fechaHora = exif.DateTime || "Desconocido";

                            const formattedShutterSpeed = formatShutterSpeed(velocidadObturacion);

                            divInfo.innerHTML = `
                                <p><strong>Resolución:</strong> ${width} x ${height}px</p>
                                <p><strong>Tamaño:</strong> ${tamanioTexto}</p>
                                <p><strong>Cámara:</strong> ${marca} ${modelo}</p>
                                <p><strong>Fecha:</strong> ${fechaHora}</p>
                                <p class="destacado"><strong>ISO:</strong> ${iso}</p>
                                <p class="destacado"><strong>Apertura:</strong> f/${numeroApertura}</p>
                                <p class="destacado"><strong>Velocidad de obturación:</strong> ${formattedShutterSpeed}</p>
                                <p><strong>Longitud focal:</strong> ${longitudFocal}</p>
                            `;
                            item.appendChild(divInfo);

                            // Guardar datos para la tabla Excel - SOLO los campos solicitados
                            imagenesData.push({
                                nombre: archivo.name,
                                iso: iso,
                                apertura: numeroApertura,
                                velocidadObturacion: formattedShutterSpeed,
                                longitudFocal: longitudFocal
                            });

                            // Procesar el siguiente archivo
                            procesarArchivoPorIndice(index + 1);
                        });
                    };
                };

                lector.readAsDataURL(archivo);
            } else {
                // Si no es imagen, pasar al siguiente
                procesarArchivoPorIndice(index + 1);
            }
        }

        // Función para crear la tabla Excel
        function crearTablaExcel() {
            if (imagenesData.length === 0) {
                alert('No hay datos para exportar. Primero selecciona algunas imágenes.');
                return;
            }

            // Preparar datos para la hoja de cálculo - SOLO los campos solicitados
            const datos = [
                ['Nombre de la imagen', 'ISO', 'Apertura (f/)', 'Velocidad de obturación', 'Longitud focal']
            ];

            imagenesData.forEach(imagen => {
                datos.push([
                    imagen.nombre,
                    imagen.iso,
                    imagen.apertura,
                    imagen.velocidadObturacion,
                    imagen.longitudFocal
                ]);
            });

            // Crear libro de trabajo y hoja
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(datos);

            // Ajustar el ancho de las columnas
            const columnas = [
                {wch: 30}, // Nombre de la imagen
                {wch: 10}, // ISO
                {wch: 12}, // Apertura
                {wch: 22}, // Velocidad de obturación
                {wch: 18}  // Longitud focal
            ];
            ws['!cols'] = columnas;

            // Añadir la hoja al libro
            XLSX.utils.book_append_sheet(wb, ws, 'Datos de Imágenes');

            // Generar el archivo Excel y descargarlo
            XLSX.writeFile(wb, 'datos_imagenes.xlsx');
        }

        // Event listeners
        document.getElementById('entradaArchivos').addEventListener('change', e => {
            procesarArchivos(e.target.files);
            resetInactivityTimer();
        });

        document.getElementById('entradaCarpeta').addEventListener('change', e => {
            procesarArchivos(e.target.files);
            resetInactivityTimer();
        });

        document.getElementById('botonTabla').addEventListener('click', crearTablaExcel);

        // Código para el GIF de inactividad
        const gifContainer = document.getElementById('gifContainer');
        const gifUrl = "https://i.pinimg.com/originals/05/fb/5f/05fb5faee5fa6cae86a5fbcdfb7792d0.gif";
        let inactivityTime = 0;
        const intervalTime = 2 * 60 * 1000;
        const maxGifs = 8;
        let gifCount = 0;
        let inactivityInterval;

        function resetInactivityTimer() {
            inactivityTime = 0;
            gifContainer.innerHTML = '';
            gifCount = 0;
        }

        function showGif() {
            if (gifCount >= maxGifs) {
                resetInactivityTimer();
                return;
            }

            const gif = document.createElement('img');
            gif.src = gifUrl;
            gif.classList.add('inactivity-gif');
            gif.style.display = 'block';

            if (gifCount % 2 === 0) {
                gif.style.marginRight = 'auto';
            } else {
                gif.style.marginLeft = 'auto';
            }

            gifContainer.appendChild(gif);
            gifCount++;
        }

        function checkInactivity() {
            const listaImagenes = document.getElementById('listaImagenes');
            if (listaImagenes.children.length === 0) {
                inactivityTime += 1000;
                if (inactivityTime % intervalTime === 0) {
                    showGif();
                }
            }
        }

        function startInactivityTimer() {
            inactivityInterval = setInterval(checkInactivity, 1000);
        }

        function stopInactivityTimer() {
            clearInterval(inactivityInterval);
        }

        window.onload = startInactivityTimer;
        window.onmousemove = resetInactivityTimer;
        window.onmousedown = resetInactivityTimer;
        window.ontouchstart = resetInactivityTimer;
        window.onclick = resetInactivityTimer;
        window.onkeypress = resetInactivityTimer;
    </script>

</body>
</html>
